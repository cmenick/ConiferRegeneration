---
title: "01_fireselection"
author: "Casey Menick"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

# Set Up

```{r packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(terra)
library(sf)
library(mapview)
library(raster)
library(rgeos)
library(stars)
library(lubridate)
library(ggplot2)
library(exactextractr)
library(patchwoRk)
library(gridExtra)
```

# Define Fire Parameters

## USDA National Forest Type Group Dataset (2004)
Conifer Forest Type Groups: Douglas-Fir, Ponderosa Pine, Fir-Spruce-Mountain Hemlock, Lodgepole Pine

```{r forest type groups, message=FALSE, warning=FALSE}
# forest type groups and key
conus_forestgroup <- raster('data/conus_forestgroup.tif')
forest_codes <- read_csv('data/forestgroupcodes.csv')

# set crs
crs = crs(conus_forestgroup)

# mapview(conus_forestgroup,maxpixels =  317219032)
```

##EPA level-3 Ecoregions
Canadian Rockies, Idaho Batholith, Middle Rockies, Columbian Mountains - Northern Rockies

```{r ecoregions, message=FALSE, warning=FALSE}
# level 3 ecoregions
l3eco <- st_read('data/us_eco_l3.shp') %>% 
  st_transform(., crs=crs)

# select northern rocky mountains from level3 ecoregions
eco_select <- l3eco %>% 
  filter(NA_L3NAME %in% c('Canadian Rockies','Columbia Mountains/Northern Rockies','Middle Rockies','Idaho Batholith'))

mapview(eco_select)
```

##MTBS Fires

  -1988-1996

  -5000+ acres of burning

  -500+ acres of high-severity

  -Within selected ecoregions

  ->25% of selected forest types
  
```{r message=FALSE, warning=FALSE}
# mtbs fire perimeters
mtbs_full <- st_read('data/mtbs_perims_DD.shp') %>% 
  st_transform(., crs=crs)
```

  
```{r initial fire selection, message=FALSE, warning=FALSE}
# select fires qualities of interest
# region of interest, 1988-1996, over 5k acres, some high severity
mtbs_select <- mtbs_full %>% 
  mutate(state = str_sub(Event_ID,0,2),
         year = year(as.Date(Ig_Date))) %>% 
  filter(state %in% c("WA","ID","MT","WY","SD"),
         Incid_Type == "Wildfire",
         between(Ig_Date, as.Date('1988-01-1'), as.Date('1996-12-31'))) %>% 
  group_by(Event_ID,Incid_Name,Ig_Date,year) %>% 
  summarize(geometry= st_union(geometry),
          acres=sum(BurnBndAc),
          min_High_T = min(High_T),
          max_High_T = max(High_T)) %>% 
     filter(min_High_T != -9999,
            max_High_T != 9999,
            acres >= 5000)
  
# assign proportions of forest type to each fire polygon
fires_join <- st_join(mtbs_select,eco_select,join=st_intersects,left=FALSE,largest=TRUE) %>% 
  left_join(., exact_extract(conus_forestgroup,mtbs_select, append_cols = TRUE, max_cells_in_memory = 3e+08, 
                             fun = function(value, coverage_fraction) {
                               data.frame(value = value,
                                          frac = coverage_fraction / sum(coverage_fraction)) %>%
                                 group_by(value) %>%
                                 summarize(freq = sum(frac), .groups = 'drop') %>%
                                 pivot_wider(names_from = 'value',
                                             names_prefix = 'freq_',
                                             values_from = 'freq')}) %>%
              mutate(across(starts_with('freq'), replace_na, 0)))
 
# remove duplicates from ecoregion boundary crossover
# remove unnecessary columns, cleanup names
# filter to remove majority other forest types, majority not-forested cover
fires <- fires_join %>% 
  dplyr::select("Event_ID","Incid_Name","year","Ig_Date","acres","US_L3NAME","freq_0","freq_200","freq_220","freq_260","freq_280") %>% 
  rename("fire_name"="Incid_Name",
         "fire_acres"="acres",
         "date"="Ig_Date",
         "ecoregion" = "US_L3NAME",
         "freq_df"="freq_200",
         "freq_pp"="freq_220",
         "freq_fs"="freq_260",
         "freq_lpp"="freq_280") %>% 
  mutate(freq_allother = 1-(freq_0 + freq_df+freq_pp+freq_fs+freq_lpp),
         freq_forested = 1- freq_0,
         freq_ideal = freq_df+freq_pp+freq_fs+freq_lpp)%>% 
  mutate(across(starts_with('freq'), round,2)) %>% 
  filter(freq_ideal >= 0.25)

```

```{r extract burn severity, message=FALSE, warning=FALSE}
# import all mtbs rasters via a list
rastlist <- list.files(path = "data/MTBSmosaic", pattern='.tif', all.files=TRUE, full.names=TRUE)
allrasters <- lapply(rastlist, raster)
names(allrasters) <- str_c("y", str_sub(rastlist,28,31))

# create empty dataframe
severity_list <- list()

# loop through mtbs mosasics for 1986-1996
# extract burn severity raster for all selected fires
# calculate burn severity percentages for each fire
for (i in names(allrasters)){
  mtbs_year <- allrasters[[i]]
  fire_year <- filter(fires, year==str_sub(i,2,5)) 
  raster_extract <- exact_extract(mtbs_year,fire_year, max_cells_in_memory = 3e+09,coverage_area=TRUE)
  names(raster_extract) <- fire_year$Event_ID 
  
  output_select <- bind_rows(raster_extract, .id = "Event_ID")%>%
    group_by(Event_ID , value) %>%
    summarize(total_area = sum(coverage_area)) %>%
    group_by(Event_ID) %>%
    mutate(proportion = total_area/sum(total_area))%>% 
    dplyr::select("Event_ID","value","proportion") %>% 
    spread(.,key="value",value = "proportion")
  
  severity_list[[i]] <- output_select
}

# combine extracted raster datasets
severity_df <- do.call(rbind, severity_list) 

# join burn severity % to fires polygons
# fix naming
# filter dataset for 500 acres high severity
fires_severity <- left_join(fires,severity_df,by="Event_ID")%>% 
  rename(noburn= "1",lowsev = "2", medsev = "3", highsev = "4",regrowth = "5", error = "6") %>% 
  dplyr::select(- "NaN",-"regrowth",-"error") %>% 
  mutate(highsev_acres = fire_acres*highsev)%>% 
  filter(highsev_acres > 500) 

fires_select <- fires_severity %>%
  left_join(.,exact_extract(conus_forestgroup,fires_severity, 'mode', append_cols = TRUE, max_cells_in_memory = 3e+08)) 

fires_select$mode <- as.factor(fires_select$mode)

fires_select <- fires_select %>% 
    mutate(fire_foresttype = case_when(mode==200 ~ "Douglas-Fir",
                                mode==220 ~ "Ponderosa",
                                mode==260 ~ "Fir-Spruce",
                                mode==280 ~ "Lodegepole Pine",
                                TRUE ~ "Other")) 
```

# Fire Dataset

##Selected fires by year
```{r plot year}
# plot
mapview(fires_select, zcol = "year")
```

##Selected fires by majority forest type
```{r plot forest type}
# plot
mapview(fires_select, zcol = "fire_foresttype")
```

# Export Data 

```{r}
# dir <- "G:/Other computers/My Laptop/Documents/Grad School/Research/WesternConiferRegeneration/output"
# 
# fires_export <- fires_select %>% 
#   mutate(fire_name = str_replace_all(fire_name, fixed(" "), ""),
#          Fire_ID = str_c(fire_name,"_", Event_ID),
#          year = as.integer(year))
# 
# str(fires_export)

# st_write(fires_export, dir, "fires_select.shp",driver = 'ESRI Shapefile')
```

```{r}
mgmt <- st_read("data/S_USA.Activity_SilvReforestation.shp")

mgt_filter <- mgmt %>% 
  filter(FY_COMPLET > 1988,
         STATE_ABBR %in% c('WY','MT','ID','WA',"SD")) %>% 
  st_transform(., crs=crs)
  

mgmt_select <- st_join(mgt_filter, fires_select, left = FALSE, largest = TRUE)

mgmt_selected <- mgmt_select %>% 
  filter(Certification of Natural Regeneration without Site Prep)

mapview(list(mgmt_select,fires_select),col.regions = c("red","blue"))
mapview(mgmt_select)

?mapview
```

```{r}
geom = st_union(fires_select) %>% 
  st_as_sf()

geom = fires_select %>% 
  st_buffer(.001)%>%
  st_union() %>% 
  st_as_sf()

mapview(geom)
```

