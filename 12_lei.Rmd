# Landscape Expansion

## Set Up

### Import Libraries

```{r libraries 10, message=FALSE, warning=FALSE}
library(sf)
library(terra)
library(mapview)
library(raster)
library(tidyverse)
library(ggplot2) 
library(exactextractr)
```

### Import Patch Polygons

```{r import patch4, message=FALSE, warning=FALSE}
# fire list
fire_list <- c("Fire_1_1988","Fire_2_1988","Fire_3_1988","Fire_4_1988","Fire_7_1988","Fire_9_1988","Fire_10_1988","Fire_11_1988","Fire_12_1988","Fire_13_1988","Fire_14_1988","Fire_15_1988","Fire_16_1988","Fire_18_1988","Fire_19_1988","Fire_20_1988","Fire_22_1988","Fire_23_1988","Fire_25_1988","Fire_26_1988","Fire_28_1988","Fire_29_1988","Fire_31_1988","Fire_32_1989","Fire_33_1989","Fire_35_1989","Fire_38_1989","Fire_41_1989","Fire_42_1989","Fire_48_1990","Fire_49_1991","Fire_50_1991","Fire_51_1991","Fire_54_1991")

# import high-severity patches
patches <- st_read("data/patches/highsev_patches.shp") %>% 
  mutate(Patch_ID = str_c(Fire_ID,"-",1:n())) %>% 
  st_transform(crs = "EPSG:4326")

# set crs 
crs <- crs(patches)

# import fire polygons
fires_export <- st_read("data/fire_boundaries/fires_export.shp") %>% 
  st_transform(crs = crs)
```
## Calculate Landscape Expansion

### Create Functions

```{r}
# function to calculate landscape expansion index dataset for each polygon
calculate_newgrowth_lei <- function(poly,timepoint1_raster,rast_name,fire_name,patch_edge){
  poly_buff <- st_as_sf(buffer(vect(poly),100))
  poly_ring <- st_difference(poly_buff, poly)
  
  patch_id <- poly$Patch_ID
  patch_foresttype <- poly$ptch_fr
  
  lei <- as.data.frame(exact_extract(timepoint1_raster,poly_ring)) %>% 
          group_by(value) %>% 
          summarize(n=n()) %>% 
          ungroup() %>% 
          mutate(lei = n/sum(n),
                 area_ha = round(as.numeric(st_area(poly))/10000,3),
                 timepoint = rast_name,
                 Fire_ID = fire_name,
                 Patch_ID = patch_id,
                 patch_foresttype = patch_foresttype,
                 category = case_when(lei > 0.5 ~ "infill",
                                      lei < .01 ~ "leapfrog",
                                      TRUE ~ "expansion"))%>% 
          filter(value == 2)
  return(lei)
  }
```

```{r message=FALSE, warning=FALSE}
# function to create LEI dataset for each fire's time steps
get_timesteps <- function(rast_name,rast_fire,fire_patches,patch_edge){
  print(rast_name)
  
  # select the timepoint and corresponding raster
  timepoint1 <- rast_name
  
  timepoint1_raster <- rast_fire[[timepoint1]]  %>% 
      as.factor() 
  # %>% terra::project(.,"EPSG:3857")
  
  # set up raster for the following timepoint
  timepoint2 <- str_c("t",as.numeric(str_sub(timepoint1,2,2))+1)
  timepoint2_raster <- rast_fire[[timepoint2]]  %>% 
    as.factor() 
  # %>% terra::project(.,"EPSG:3857")
  
  # set area outside of patches to "forested"
  ## later change this to ndvi that is reliably tree covered in snow
  timepoint1_raster[is.na(timepoint1_raster)] <- 2
  
  timepoint_difference_raster <- timepoint2_raster - timepoint1_raster 
  
  # convert to polygons
  timepoint_difference_polys <- as.polygons(timepoint_difference_raster) %>%
    st_as_sf() %>%
    st_cast("POLYGON") %>% 
    filter(.[[1]] == 1) %>% 
    st_transform(crs=crs) %>%
    st_join(.,fire_patches)
  
  full_lei <- timepoint_difference_polys %>% 
    rowwise() %>% 
    transmute(leidf = list(calculate_newgrowth_lei(geometry,timepoint1_raster,rast_name,fire_name,patch_edge))) %>% 
    st_drop_geometry() 
  
  lei_df <- do.call(rbind,do.call(rbind,full_lei))
  
  return(lei_df)
}
```

```{r message=FALSE, warning=FALSE}
get_lei <- function(fire_name){
  # print fire ID 
  print(fire_name)
  
  # import and name rasters for that fire
  rast_list <- list.files(path = "data/prediction_rasters", pattern = str_c(fire_name,"_rf"), all.files=TRUE, full.names=TRUE)
  rast_names <- str_sub(rast_list,start = -6, end = -5)  
  rast_fire <- rast(rast_list)
  names(rast_fire) <- rast_names
  
  # convert patch edge to linestring and reproject for distance calculation
  fire_patches <- patches %>% 
    filter(Fire_ID == fire_name) 

  patch_edge <- fire_patches %>% 
    st_cast(.,"LINESTRING")
    
  loop_names <- rast_names[1:9]
  
  lei_fullset <- lapply(loop_names, get_timesteps,rast_fire=rast_fire,fire_patches=fire_patches,patch_edge = patch_edge)
  
  
  lei_df <- do.call(rbind,lei_fullset)
  
  # lei_df <- map_dfr(loop_names,get_timesteps(rast_name=loop_names))
  return(lei_df)
}
```

### Calculate Metrics
```{r message=FALSE, warning=FALSE}
test <- get_lei(fire_name)

df <- test %>% 
  group_by(timepoint,category) %>% 
  summarize(area_ha = sum(area_ha),
            dist = mean(edge_dist_m))

ggplot(df,aes(timepoint,area_ha,color=category,group = category)) + 
  geom_point() + 
  geom_smooth()

ggplot(df,aes(timepoint,dist,color=category,group = category)) + 
  geom_point() + 
  geom_smooth()
```



