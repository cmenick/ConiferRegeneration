[["ndvi-trajectory.html", "Part 9 NDVI Trajectory 9.1 Set Up 9.2 Connect Landsat and High-Severity Patches 9.3 Prepare Dataset 9.4 Plot", " Part 9 NDVI Trajectory 9.1 Set Up 9.1.1 Libraries library(ggplot2) library(ggthemes) library(tidyverse) library(sf) library(terra) library(raster) library(mapview) library(exactextractr) 9.1.2 Import Fires # import high-severity patches patches &lt;- st_read(&quot;data/patches/highsev_patches.shp&quot;) %&gt;% st_transform(crs=&quot;EPSG: 4326&quot;) # set crs crs &lt;- crs(patches) # import fire boundaries fires_export &lt;- st_read(&quot;data/fire_boundaries/fires_export.shp&quot;)%&gt;% st_transform(., crs=crs) 9.1.3 Prepare Data for Bands and Fire Names 9.1.3.1 Bands # list band names and years bands &lt;- c(&quot;blue&quot;, &quot;green&quot;, &quot;red&quot;, &quot;nir&quot;, &quot;swir1&quot;, &quot;swir2&quot;, &quot;pixel_qa&quot;, &quot;ndvi&quot;, &quot;ndwi&quot;, &quot;nbr&quot;, &quot;nbr2&quot;, &quot;ndsi&quot;, &quot;ndfsi&quot;, &quot;savi&quot;, &quot;evi&quot;) years &lt;- c(1988:2021) # create list of all combinations of bands, in the appropriate order bandnames &lt;- list(bands,years) %&gt;% cross() %&gt;% map(lift(paste0)) bandlist &lt;- do.call(rbind,bandnames) 9.1.3.2 Fire Names # get list of fire names fire_names &lt;- unique(fires_export$Fire_ID) ## subset for testing fire_names &lt;- c(&quot;Fire_44_1990&quot;,&quot;Fire_45_1990&quot;,&quot;Fire_46_1990&quot;,&quot;Fire_47_1990&quot;,&quot;Fire_48_1990&quot;,&quot;Fire_49_1991&quot;,&quot;Fire_50_1991&quot;,&quot;Fire_51_1991&quot;,&quot;Fire_52_1991&quot;,&quot;Fire_53_1991&quot;) 9.2 Connect Landsat and High-Severity Patches 9.2.1 Function to Extract Landsat # create function extract_landsat &lt;- function(fire_name){ # print(paste0(&quot;Starting Fire &quot;,fire_name)) # get list of this fire&#39;s tif files rast_list &lt;- list.files(path = &quot;data/landsat/landsat_clipped&quot;, pattern=fire_name, all.files=TRUE, full.names=TRUE) # larger rasters were exported from GEE as multiple files, need to be combined before importing if (length(rast_list)&gt;1) { # print(paste0(length(rast_list),&quot; rasters, merging...&quot;)) rast_all &lt;- lapply(rast_list, rast) rast_collection &lt;- do.call(merge,rast_all) } else { # print(&quot;Only one raster, adding directly to raster list&quot;) rast_collection &lt;- rast(rast_list) } # name the bands names(rast_collection) &lt;- bandlist # verify crs crs(rast_collection) &lt;- &quot;EPSG: 4326&quot; # filter the patches for this fire fire_patches &lt;- patches %&gt;% filter(Fire_ID==fire_name) %&gt;% st_transform(crs=crs(rast_collection)) # get the mean landsat values for each patch in this fire extracted_data &lt;- left_join(fire_patches, exact_extract(rast_collection,fire_patches, append_cols = TRUE, max_cells_in_memory = 3e+08, fun = &quot;mean&quot;)) %&gt;% st_drop_geometry() # export return(extracted_data) } 9.2.2 Extract Landsat Data for Each Patch # map extraction function across all fires extracted_fires &lt;- map(fire_names,extract_landsat) # combine dataset landsat_dataset &lt;- do.call(rbind, extracted_fires) 9.3 Prepare Dataset 9.3.1 Clean Data # clean dataset, label, select only ndvi, calculate pre-fire ndvi &amp; differenced ndvi ndvi_dataset &lt;- landsat_dataset %&gt;% mutate(Patch_ID = str_c(Fire_ID,&quot;-&quot;,1:n()), prefire_yr = year-1, patch_area_class = case_when(ptch_r_ &gt;= 1000 ~ &quot;giant&quot;, ptch_r_ &lt; 1000 &amp; ptch_r_ &gt;= 500 ~ &quot;large&quot;, ptch_r_ &lt; 500 &amp; ptch_r_ &gt;= 100 ~ &quot;big&quot;, ptch_r_ &lt; 100 &amp; ptch_r_ &gt;= 50 ~ &quot;medium&quot;, ptch_r_ &lt; 50 &amp; ptch_r_ &gt;= 10 ~ &quot;small&quot;, TRUE ~ &quot;tiny&quot;)) %&gt;% rename(fire_yr = year, patch_area = ptch_r_, patch_foresttype = ptch_fr, Event_ID = Evnt_ID, Incid_Name = Incd_Nm, ecoregion = ecoregn) %&gt;% dplyr::select(Event_ID, Incid_Name, Fire_ID, Patch_ID, prefire_yr, fire_yr, ecoregion, patch_foresttype, patch_area, patch_area_class, contains(&quot;ndvi&quot;)) %&gt;% pivot_longer(.,contains(&quot;ndvi&quot;),names_to = &quot;landsat_yr&quot;, values_to = &quot;ndvi&quot;) %&gt;% mutate(landsat_yr = landsat_yr %&gt;% stringr::str_remove(&quot;mean.ndvi&quot;)) %&gt;% mutate(prefire_ndvi = case_when(prefire_yr == landsat_yr ~ ndvi)) %&gt;% group_by(Patch_ID) %&gt;% mutate(prefire_ndvi = mean(prefire_ndvi, na.rm=TRUE)) %&gt;% ungroup() %&gt;% mutate(delta_ndvi = ndvi - prefire_ndvi) 9.3.2 Regroup Data ndvi_grouped_type &lt;- ndvi_dataset %&gt;% group_by(patch_foresttype,landsat_yr) %&gt;% summarize(ndvi=mean(ndvi), delta_ndvi = mean(delta_ndvi)) %&gt;% drop_na() ## `summarise()` has grouped output by &#39;patch_foresttype&#39;. You can override using ## the `.groups` argument. ndvi_grouped_size &lt;- ndvi_dataset %&gt;% group_by(patch_area_class,landsat_yr) %&gt;% summarize(ndvi=mean(ndvi), delta_ndvi = mean(delta_ndvi)) %&gt;% drop_na() ## `summarise()` has grouped output by &#39;patch_area_class&#39;. You can override using ## the `.groups` argument. 9.4 Plot 9.4.1 NDVI Change by Forest Type ggplot(ndvi_grouped_type,aes(landsat_yr,ndvi,color=patch_foresttype,group=patch_foresttype))+ geom_line(size=1) + theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1)) + labs(x=&quot;Year&quot;,y=&quot;NDVI&quot;,title= &quot;NDVI Change Overtime 30 Years Post-Fire&quot;,color = &quot;Patch Forest Type&quot;) # ggplot(ndvi_grouped_type,aes(landsat_yr,ndvi,color=patch_foresttype,group=patch_foresttype))+ # geom_point() + # geom_smooth(method=&quot;auto&quot;,se=FALSE) + # theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1)) # ggplot(ndvi_grouped_type%&gt;% dplyr::filter (patch_foresttype %in% c(&quot;Douglas-Fir&quot;,&quot;Fir-Spruce&quot;,&quot;Lodegepole Pine&quot;)),aes(landsat_yr ,ndvi,color=patch_foresttype,group=patch_foresttype)) + # geom_line(size=1) + # theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1)) 9.4.2 NDVI Recovery by Forest Type # by ndvi diff # ggplot(ndvi_grouped_type,aes(landsat_yr,delta_ndvi,color=patch_foresttype,group=patch_foresttype))+ # geom_point() + # geom_smooth(method=&quot;auto&quot;,se=FALSE) + # theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1)) ggplot(ndvi_grouped_type,aes(landsat_yr,delta_ndvi,color=patch_foresttype,group=patch_foresttype))+ geom_line(size=1) + theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1)) + labs(x=&quot;Year&quot;,y=&quot;Change in NDVI from Pre-Fire&quot;,title= &quot;NDVI Difference from Pre-Fire 30 Years Post-Fire&quot;,color = &quot;Patch Forest Type&quot;) ### NDVI Chaneg by Patch Area # ggplot(ndvi_grouped_size,aes(landsat_yr,ndvi,color=patch_area_class,group=patch_area_class))+ # geom_point() + # geom_smooth(method=&quot;auto&quot;,se=FALSE) + # theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1)) ggplot(ndvi_grouped_size,aes(landsat_yr,ndvi,color=patch_area_class,group=patch_area_class))+ geom_line(size=1) + theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1)) + labs(x=&quot;Year&quot;,y=&quot;NDVI&quot;,title= &quot;NDVI Change Overtime 30 Years Post-Fire&quot;,color = &quot;Patch Size&quot;) "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
