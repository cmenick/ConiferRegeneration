# Model Development

## Set Up

### Libraries

```{r libraries5, message=FALSE, warning=FALSE}
library(mapview)
library(sf)
library(terra)
library(tidyverse)
library(ggplot2)
library(car)
library(forcats)
library(randomForest)
library(raster)
```

### Import Snow-Cover Landsat for 2020-2021 Winter

```{r landsat import}
# bring in snow-on landsat imagery tiles, merge into collection
rast_list <- list.files(path = "data/landsat/landsat_2021", pattern='.tif', all.files=TRUE, full.names=TRUE)
rast_all <- lapply(rast_list, rast)
rast_collection <- sprc(rast_all)

crs <- crs(rast_collection[1])
```

### Import Fire Boundaries

```{r fire boundary import}
fires_export <- st_read("data/fire_boundaries/fires_export.shp")%>% 
  st_transform(., crs=crs)
```

### Import Training Points

```{r import points}
# bring in training points
points <- st_read("data/points/points_export.shp") %>% 
  st_transform(crs=crs)
```

## Prepare Training Data

### Extract Landsat Values

```{r extract landsat}
# extract landsat values to each training point
extracted_df <- list()
for(i in 1:length(rast_all)){
  extracted_points <- st_as_sf(terra::extract(rast_collection[i], points,bind = TRUE))
  extracted_df[[i]] <- extracted_points 
}
training_dataset <- do.call(rbind,extracted_df) %>% 
  mutate(absence = as.factor(case_when(class == "absence" ~ "absence",
                                       TRUE ~ "presence")),
         class = case_when(class == "presence20to40" ~ "20-60%",
                           class == "presence40to60" ~ "20-60%",
                           class == "presence10to20" ~ "10-20%",
                           class == "presence1to10" ~ "1-10%",
                           class == "presencetrace" ~ "<1%",
                           class == "presence60plus" ~ ">60%",
                           TRUE ~ "absence"),
         class = fct_relevel(as.factor(class),c("absence","<1%","1-10%","10-20%","20-60%",">60%"))) %>% 
  rename(f_type = ptch_fr,
         area_ha = ptch_r_) %>% 
  st_drop_geometry() %>% 
  dplyr::select(-pixel_qa,-qd_vnt_,-qd_fr_d) %>% 
  drop_na(ndvi)
```

### Training Data by Forest Type

```{r data by ftype}
pres_abs_type <- training_dataset %>% 
  group_by(f_type,absence) %>% 
  summarize(n=n()) %>% 
  mutate(percent= 100*n/sum(n)) %>% 
  filter(absence=="presence")
pres_abs_type
```

## Examine Data 

### Plot NDVI by Density Class

```{r ggplotting, message=FALSE, warning=FALSE}
ggplot(training_dataset,aes(class,ndvi)) +
  geom_boxplot() + 
  labs(title = "NDVI by Percent Conifer Cover Class: All Classes",x = "Visually Estimated Conifer Percent Cover",y = "NDVI")

ggplot(training_dataset %>% filter(class %in% c("absence","<1%")),aes(class,ndvi)) +
  geom_boxplot()+
  ylim(-.1,.1) + 
  labs(title = "NDVI by Percent Conifer Cover Class: Trace Conifer Class vs. Absence",x = "Visually Estimated Conifer Percent Cover",y = "NDVI")

ggplot(training_dataset,aes(absence,ndvi)) +
  geom_boxplot() + 
  labs(title = "NDVI by Percent Conifer Cover Class: Presence vs. Absence ",x = "Visually Estimated Conifer Percent Cover",y = "NDVI")
```

## Model

### Logistic

```{r log model vif}
# full model 
lm_conifer <- glm(absence ~ red + green + blue + nir + swir1 + swir2 + ndsi + ndfsi + ndvi + evi + nbr + nbr2 + ndwi, 
                  data = training_dataset, family = binomial(logit))
vif(lm_conifer)

# remove
lm_conifer <- glm(absence ~ red + green + blue + nir + swir1 + swir2 + ndsi + ndfsi + ndvi + evi + nbr + nbr2 + ndwi, 
                  data = training_dataset, family = binomial(logit))
vif(lm_conifer)

# remove
lm_conifer <- glm(absence ~ red + green + blue + nir + swir1 + swir2 + ndsi + ndfsi + ndvi + evi + nbr + nbr2 + ndwi, 
                  data = training_dataset, family = binomial(logit))
vif(lm_conifer)

# remove
lm_conifer <- glm(absence ~ red + green + blue + nir + swir1 + swir2 + ndsi + ndfsi + ndvi + evi + nbr + nbr2 + ndwi, 
                  data = training_dataset, family = binomial(logit))
vif(lm_conifer)

# remove
lm_conifer <- glm(absence ~ red + green + blue + nir + swir1 + swir2 + ndsi + ndfsi + ndvi + evi + nbr + nbr2 + ndwi, 
                  data = training_dataset, family = binomial(logit))
vif(lm_conifer)

# remove
lm_conifer <- glm(absence ~ red + green + blue + nir + swir1 + swir2 + ndsi + ndfsi + ndvi + evi + nbr + nbr2 + ndwi, 
                  data = training_dataset, family = binomial(logit))
vif(lm_conifer)
```


```{r log model}
# final model
summary(lm_conifer)
anova(lm_conifer)
```

## Random Forest

```{r rf model}
rf_conifer <- randomForest(absence ~ red + green + blue + nir + swir1 + swir2 + ndsi + ndfsi + ndvi + evi + nbr + nbr2 + ndwi,
                           data= training_dataset %>% drop_na())
```

```{r rf model importance}
randomForest::importance(rf_conifer)
```

```{r rf model summary}
summary(rf_conifer)
```